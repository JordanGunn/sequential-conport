# Project Loki: Fire Weather Index & Fire Behavior Prediction System

## Project Overview

**Loki** is a comprehensive fire weather prediction system developed for the **Government of Alberta** to modernize and enhance their wildfire management capabilities. The project transforms legacy R-based fire weather calculations into a robust, high-performance Python application that **unifies two distinct operational workflows** - tabular station forecasts and spatial landscape mapping - into a single, cohesive system with both CLI automation and GUI interfaces.

## Project Goals & Context

### Primary Objectives
1. **Legacy Modernization**: Convert monolithic R code (CFFDRS R package) to clean, modular Python
2. **Workflow Unification**: Integrate separate tabular and mapping tools into a single comprehensive system
3. **Performance Enhancement**: Implement proper software engineering principles and optimize computational performance
4. **Automation Support**: Provide CLI interface for automated fire weather prediction workflows
5. **User Accessibility**: Create intuitive GUI for non-technical users (fire weather specialists, operational staff)

### Critical Mission
This tool directly supports **Alberta's provincial fire management operations** by providing accurate, timely fire weather predictions that inform:
- **Fire danger assessments** across Alberta's forested regions
- **Resource allocation** for firefighting teams and equipment  
- **Public safety decisions** regarding fire bans and evacuations
- **Long-term fire season planning** and preparedness strategies

## Legacy System Integration Challenge

### Original Dual-Tool Architecture
Alberta's current fire weather operations depend on **two separate R-based tools**:

#### Tabular Tool (`tabular.R`)
- **Station-focused forecasts**: Processes multiple weather stations with various forecast models
- **Professional table outputs**: Color-coded FWI/FBP metrics in Word documents
- **Multi-model support**: GDPS, RDPS, GEPS, GFS weather models
- **Operational formatting**: Tables optimized for daily briefings and field distribution

#### Mapping Tool (`mapping.R`)
- **Spatial landscape analysis**: Gridded fire weather predictions across Alberta
- **Professional cartographic outputs**: PDF maps showing fire danger across forest protection areas
- **Spatial interpolation**: IDW processing of station data for continuous surfaces
- **Multi-parameter visualization**: Both fire weather indices and underlying meteorological inputs

### Unification Opportunity & Benefits

**Significant functional overlap** exists between the two tools:
- **Shared data dependencies**: Both use identical RAWS stations, weather databases, and FWI algorithms
- **Common calculation workflows**: Same cffdrs-based FWI/FBP processing with identical threshold matrices
- **Complementary outputs**: Point-based tables and spatial maps serve different but related operational needs
- **Overlapping maintenance burden**: Duplicate code for weather processing, classification, and formatting

**Unified system advantages**:
- **Consistent results** across point and spatial outputs using shared calculation engines
- **Operational efficiency** through common data acquisition and processing workflows
- **Enhanced capabilities** (e.g., spatial interpolation for tabular station analysis)
- **Reduced maintenance** by eliminating duplicate functionality
- **Integrated user experience** allowing operators to seamlessly switch between tabular and mapping outputs

## Technical Architecture

### Core System: Canadian Forest Fire Weather Index (FWI)

The system implements the **Canadian Forest Fire Weather Index System**, the national standard for fire weather assessment consisting of:

#### Fuel Moisture Codes (Foundation Metrics)
- **FFMC (Fine Fuel Moisture Code)**: Moisture in surface litter - indicates ignition potential
- **DMC (Duff Moisture Code)**: Moisture in organic layers - indicates fuel consumption  
- **DC (Drought Code)**: Deep soil moisture - indicates seasonal drought effects

#### Fire Behavior Indices (Predictive Metrics)
- **ISI (Initial Spread Index)**: Expected fire spread rate
- **BUI (Buildup Index)**: Total available fuel for combustion
- **FWI (Fire Weather Index)**: Overall fire intensity rating
- **DSR (Daily Severity Rating)**: Fire suppression difficulty

#### Fire Behavior Prediction (FBP) Extensions
- **ROS (Rate of Spread)**: Actual fire spread rates by fuel type
- **HFI (Head Fire Intensity)**: Fire line intensity
- **FD (Fire Description)**: Categorized fire behavior (surface, crown, conflagration)

### Data Sources & Integration

#### Weather Data Sources
1. **RAWS Station Network**: 262+ ground-based weather stations across Alberta
   - **Real-time observations**: Temperature, humidity, wind speed, precipitation
   - **Historical data**: Provides seeding values for predictive calculations
   - **Current access**: Via `data.bin` files (transitioning to direct database access)

2. **Dual Forecast Integration**:
   - **SpotWX API**: Point forecasts for individual stations (tabular workflow)
   - **GeoMet Web Coverage Service**: Gridded forecasts for spatial analysis (mapping workflow)
   - **Forecast models**: GDPS (Global), RDPS (Regional) 
   - **Prediction horizon**: 7+ days ahead
   - **Temporal alignment**: Both systems extract 18:00Z (12:00 noon local) for FWI calculations

#### Unified Computational Workflow
```

                    Weather Data Acquisition
                   /                        \
        Point Forecasts                 Gridded Forecasts
         (SpotWX API)                    (GeoMet WCS)
              |                              |
              v                              v
        Station Processing              Spatial Processing
              |                              |
              \                              /
               \                            /
                \                          /
                 v                        v
              Shared FWI Calculation Engine
                         |
                         v
              Classification & Formatting
                      /        \
                     v          v
              Tabular Outputs   Spatial Outputs
              (Word Documents)  (PDF Maps)
```
### Software Architecture

#### Unified Modular Design
- **calculator/**: Three-tier dependency architecture for fire weather calculations (shared core engine)
- **weather/**: Unified data acquisition supporting both point and gridded forecasts  
- **pipeline/**: Integrated orchestration workflows supporting both tabular and mapping outputs
- **cli/**: Command-line automation interface with mode selection (tabular/mapping/unified)
- **gui/**: PyQt5-based interface allowing seamless switching between output modes

#### Key Technical Patterns
1. **Shared Calculation Core**: Single FWI/FBP engine used by both tabular and mapping workflows
2. **Dual Data Acquisition**: Parallel weather data fetching from SpotWX (point) and GeoMet (gridded) sources
3. **Unified Classification**: Shared fire danger thresholds and color schemes across all outputs
4. **Modular Output Generation**: Pluggable formatters for tables (Word) and maps (PDF)
5. **Configuration-Driven Workflows**: CLI/GUI inputs determine whether to generate tabular, spatial, or combined outputs

#### Integration Architecture
```

Loki Unified System:
├── Data Layer
│   ├── RAWS Station Network (shared)
│   ├── Weather Database (shared)
│   ├── SpotWX Client (tabular-specific)
│   └── GeoMet Client (mapping-specific)
├── Processing Layer
│   ├── FWI Calculation Engine (shared)
│   ├── Classification Engine (shared)
│   ├── Station Interpolation (mapping-specific)
│   └── Temporal Processing (shared)
└── Output Layer
    ├── Tabular Formatter → Word Documents
    ├── Spatial Formatter → PDF Maps
    └── Combined Outputs → Integrated Reports
```
## User Interfaces

### Command Line Interface (CLI)
- **Unified workflows** supporting tabular, mapping, or combined output modes
- **Automated daily operations** for both station forecasts and landscape mapping
- **Batch processing** of multiple stations, forecast models, and time periods
- **Mode selection**: `--mode tabular|mapping|unified` for operational flexibility
- **Integration** with Alberta's existing fire management systems

### Graphical User Interface (GUI)
- **Professional PyQt5 interface** with Alberta Wildfire branding
- **Integrated workflow selection**: Toggle between tabular and mapping modes within single interface
- **Interactive station selection** with map visualization
- **Real-time progress tracking** for long-running calculations
- **Unified export capabilities** for all output formats (Word, PDF, CSV, JSON)
- **User-friendly controls** for non-technical fire weather specialists

## Operational Impact

### For Alberta Wildfire Operations
- **Unified daily operations**: Single tool produces both station-specific tables and landscape-wide maps
- **Consistent fire danger assessments** across 262+ monitoring stations and spatial grids
- **7-day forward predictions** for both tactical (station) and strategic (landscape) planning
- **Automated processing** reduces manual calculation time from hours to minutes
- **Standardized outputs** ensure consistency across all provincial regions and output formats
- **Enhanced operational capability**: Spatial context for station-based decisions and vice versa

### Technical Improvements Over Legacy Dual-System
- **Performance**: ~10x faster computation through vectorized operations and shared processing
- **Consistency**: Single calculation engine eliminates discrepancies between tabular and mapping outputs
- **Reliability**: Comprehensive error handling and data validation across unified workflows
- **Maintainability**: Modular architecture replaces dual monolithic R scripts
- **Scalability**: Async processing handles multiple forecast models and output formats simultaneously
- **Usability**: Modern interfaces replace separate command-line R workflows
- **Operational efficiency**: Single tool training and maintenance instead of dual-system management

## Development Context for Junie

As the development AI, you'll be working within a system that:
- **Unifies previously separate operational workflows** into a cohesive fire weather prediction platform
- **Directly impacts public safety** through accurate fire weather predictions across multiple output formats
- **Processes real operational data** from Alberta's fire management network for both point and spatial analysis
- **Requires high reliability** as it supports critical decision-making at both tactical and strategic levels
- **Follows strict architectural patterns** ensuring shared functionality and consistent results
- **Integrates multiple complex domains** (meteorology, fire science, spatial analysis, software engineering)

Your work contributes to protecting Alberta's forests, communities, and firefighting personnel through a unified, advanced fire weather prediction system that seamlessly integrates station-specific forecasts with landscape-wide fire danger mapping.
